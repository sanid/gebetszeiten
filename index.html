<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- SEO Meta Tags -->
    <title>Gebetszeiten Deutschland & Weltweit - Kostenlos & Pr√§zise</title>
    <meta name="description" content="Aktuelle islamische Gebetszeiten f√ºr Berlin, Deutschland und weltweit. Genaue Zeiten f√ºr Fajr, Dhuhr, Asr, Maghrib und Isha mit automatischem Standort, Hijri-Datum und Countdown.">
    <meta name="keywords" content="Gebetszeiten, Namaz Zeit, Salah, Muslimische Gebetszeiten, Islam, Gebetskalender, Berlin, Deutschland, Fajr, Maghrib, Isha, Moschee, Gebet">
    <meta name="author" content="Gebetszeiten App">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://gebetszeiten.live/">
    <meta property="og:title" content="Gebetszeiten Deutschland & Weltweit">
    <meta property="og:description" content="Pr√§zise islamische Gebetszeiten f√ºr deinen Standort. Mit Countdown, Monats√ºbersicht und Hijri-Datum.">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Gebetszeiten Deutschland & Weltweit">
    <meta property="twitter:description" content="Pr√§zise islamische Gebetszeiten f√ºr deinen Standort. Mit Countdown, Monats√ºbersicht und Hijri-Datum.">

    <!-- PWA / Mobile Optimization -->
    <meta name="theme-color" content="#0f172a"> <!-- Dunkles Blau passend zum Header -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gebetszeiten">

    <!-- Inline Manifest for PWA (Data URI) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiR2ViZXRzemVpdGVuIEFwcCIsInNob3J0X25hbWUiOiJHZWJldHN6ZWl0ZW4iLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmM2Y0ZjYiLCJ0aGVtZV9jb2xvciI6IiMwZjE3MmEiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9jZG4tanRpZmYuYWxYcGxvcmVyLm5ldC9hc3NldHMvaWNvbnMvcHJheWVyLWFwcC1pY29uLTE5Mi5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn0seyJzcmMiOiJodHRwczovL2Nkbi1qdGlmZi5hbFhwbG9yZXIubmV0L2Fzc2V0cy9pY29ucy9wcmF5ZXItYXBwLWljb24tNTEyLnBuZyIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9wbmcifV19">

    <!-- Favicon (using emoji as fallback) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üïå</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%230f172a%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2270%22>üïå</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: 'var(--color-primary-50)',
                            100: 'var(--color-primary-100)',
                            200: 'var(--color-primary-200)',
                            400: 'var(--color-primary-400)',
                            500: 'var(--color-primary-500)',
                            600: 'var(--color-primary-600)',
                            700: 'var(--color-primary-700)',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Page Transitions -->
    <link rel="stylesheet" href="transition.css">

    <style>
        :root {
            --color-primary-50: #ecfdf5;
            --color-primary-100: #d1fae5;
            --color-primary-200: #a7f3d0;
            --color-primary-400: #34d399;
            --color-primary-500: #10b981;
            --color-primary-600: #059669;
            --color-primary-700: #047857;
            --color-primary-shadow: rgba(16, 185, 129, 0.3);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* Prevent pull-to-refresh on mobile which looks weird in standalone mode */
            overscroll-behavior-y: none;
            transition: background-color 0.3s ease;
        }
        html.dark body {
            background-color: #0f172a;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        html.dark .glass-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .prayer-active {
            background: linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-600) 100%);
            color: white;
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px var(--color-primary-shadow);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid var(--color-primary-500);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-200 antialiased min-h-screen flex flex-col">

    <!-- Audio Element (Source set dynamically via JS) -->
    <audio id="adhan-audio" preload="none"></audio>

    <!-- Header / Hero Section -->
    <header class="bg-slate-900 text-white pb-24 pt-8 px-4 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-10">
            <i class="fas fa-mosque absolute -bottom-10 -right-10 text-9xl"></i>
            <i class="far fa-star absolute top-10 left-10 text-4xl animate-pulse"></i>
        </div>

        <div class="max-w-2xl mx-auto relative z-10">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">Gebetszeiten</h1>
                    <p class="text-slate-400 text-sm" id="current-date-display">L√§dt...</p>
                </div>

                <div class="flex items-center gap-2">
                    <button onclick="toggleSettings()" class="bg-slate-800 hover:bg-slate-700 py-2 px-3 rounded-full transition flex items-center shadow-lg border border-slate-700">
                        <i class="fas fa-map-marker-alt text-primary-400"></i>
                        <span id="location-name" class="ml-2 text-sm font-medium">Berlin</span>
                    </button>
                    <button onclick="toggleSettings()" class="bg-slate-800 hover:bg-slate-700 p-2 rounded-full transition w-10 h-10 flex items-center justify-center shadow-lg border border-slate-700" title="Einstellungen">
                        <i class="fas fa-cog text-slate-300 hover:text-white transition-colors"></i>
                    </button>
                </div>
            </div>

            <!-- Next Prayer Highlight -->
            <div class="text-center mt-6">
                <p class="text-slate-400 text-sm uppercase tracking-wider mb-1">N√§chstes Gebet in</p>
                <div id="countdown" class="text-4xl md:text-5xl font-bold font-mono text-primary-400 mb-2">--:--:--</div>
                <p id="next-prayer-name" class="text-xl font-medium text-white">L√§dt...</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow px-4 -mt-16 relative z-20 pb-10">
        <div class="max-w-2xl mx-auto space-y-6">

             <!-- Audio Control Button (Zwischen Countdown und Heute) -->
             <!-- Hidden by default via class, toggled by JS if adhan enabled -->
             <div id="player-container" class="hidden justify-center mb-2 animate-fade-in">
                <button id="adhan-control-btn" onclick="toggleAdhanPlayback()" class="glass-card bg-white/90 dark:bg-slate-800/90 text-slate-700 dark:text-slate-200 px-6 py-2 rounded-full shadow-lg flex items-center gap-3 transition hover:scale-105 active:scale-95 border-0">
                    <div id="play-icon-container" class="w-8 h-8 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-primary-600 dark:text-primary-400">
                        <i class="fas fa-play ml-1 text-sm"></i>
                    </div>
                    <div class="text-left">
                        <p class="text-[10px] text-gray-500 dark:text-gray-400 font-semibold uppercase tracking-wider">Adhan Player</p>
                        <p id="adhan-status-text" class="text-xs font-medium">Bereit</p>
                    </div>
                </button>
            </div>

            <!-- Settings Panel (Hidden by default) -->
            <div id="settings-panel" class="hidden glass-card rounded-2xl shadow-xl p-6 mb-6 animate-fade-in ring-1 ring-black/5 dark:ring-white/10">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-gray-800 dark:text-gray-100">Einstellungen</h3>
                    <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i class="fas fa-times"></i></button>
                </div>

                <!-- Location Section -->
                <div class="mb-6">
                    <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Standort</label>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="city-search" placeholder="Stadt eingeben (z.B. K√∂ln)..."
                               class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none">
                        <button onclick="searchCity()" class="bg-slate-800 text-white px-4 py-2 rounded-lg hover:bg-slate-700">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <button onclick="detectLocation()" class="w-full py-2 border border-primary-500 text-primary-600 dark:text-primary-400 dark:hover:bg-primary-900/30 rounded-lg hover:bg-primary-50 transition flex justify-center items-center gap-2 text-sm font-medium">
                        <i class="fas fa-location-arrow"></i> Meinen Standort verwenden
                    </button>
                    <div id="location-loading" class="hidden justify-center mt-2"><div class="loader"></div></div>
                </div>

                <div class="h-px bg-gray-200 dark:bg-gray-700 w-full mb-6"></div>

                <!-- Adhan Settings -->
                <div class="mb-6">
                    <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Adhan & Erinnerungen</label>

                    <!-- Main Audio Toggle -->
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm text-gray-700 dark:text-gray-300">Audio abspielen</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="adhan-toggle" class="sr-only peer" onchange="saveAdhanSettings()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-500 dark:bg-gray-700 dark:peer-checked:bg-primary-500"></div>
                        </label>
                    </div>

                    <!-- Notification Toggle (NEU) -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Desktop Benachrichtigung</span>
                            <span class="text-[10px] text-gray-400 dark:text-gray-500">System-Popup anzeigen</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="notification-toggle" class="sr-only peer" onchange="toggleNotifications()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500 dark:bg-gray-700 dark:peer-checked:bg-blue-500"></div>
                        </label>
                    </div>

                    <!-- Offset Setting -->
                    <div class="flex items-center gap-3 mb-3">
                        <input type="number" id="adhan-offset-input" min="0" max="60" value="10" class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 dark:bg-slate-700 dark:text-white rounded text-center" onchange="saveAdhanSettings()">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Minuten vor dem Gebet</span>
                    </div>

                    <!-- Fajr Special Toggle -->
                    <div class="flex items-center justify-between mt-2">
                        <span class="text-sm text-gray-700 dark:text-gray-300">Spezieller Fajr Adhan</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="fajr-adhan-toggle" class="sr-only peer" onchange="saveAdhanSettings()">
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary-500 dark:bg-gray-700 dark:peer-checked:bg-primary-500"></div>
                        </label>
                    </div>
                    <p class="text-[10px] text-gray-400 dark:text-gray-500 mt-2">Gilt f√ºr alle Gebete au√üer Sonnenaufgang.</p>
                </div>

                <div class="h-px bg-gray-200 dark:bg-gray-700 w-full mb-6"></div>

                <!-- Theme Settings -->
                <div class="mb-6">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Design</label>

                    <!-- Dark Mode Toggle -->
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm text-gray-700 dark:text-gray-300">Dunkelmodus</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="dark-mode-toggle" class="sr-only peer" onchange="handleToggleDarkMode()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-slate-700 dark:bg-gray-700 dark:peer-checked:bg-primary-500"></div>
                        </label>
                    </div>

                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Farbthema</label>
                    <div class="flex gap-3 justify-start flex-wrap">
                        <button onclick="handleSetTheme('emerald')" class="w-8 h-8 rounded-full bg-[#10b981] hover:ring-2 ring-offset-2 ring-[#10b981] transition-transform hover:scale-110 shadow-sm" aria-label="Emerald Theme"></button>
                        <button onclick="handleSetTheme('blue')" class="w-8 h-8 rounded-full bg-[#3b82f6] hover:ring-2 ring-offset-2 ring-[#3b82f6] transition-transform hover:scale-110 shadow-sm" aria-label="Blue Theme"></button>
                        <button onclick="handleSetTheme('purple')" class="w-8 h-8 rounded-full bg-[#8b5cf6] hover:ring-2 ring-offset-2 ring-[#8b5cf6] transition-transform hover:scale-110 shadow-sm" aria-label="Purple Theme"></button>
                        <button onclick="handleSetTheme('amber')" class="w-8 h-8 rounded-full bg-[#f59e0b] hover:ring-2 ring-offset-2 ring-[#f59e0b] transition-transform hover:scale-110 shadow-sm" aria-label="Amber Theme"></button>
                        <button onclick="handleSetTheme('red')" class="w-8 h-8 rounded-full bg-[#ef4444] hover:ring-2 ring-offset-2 ring-[#ef4444] transition-transform hover:scale-110 shadow-sm" aria-label="Red Theme"></button>
                        <button onclick="handleSetTheme('yellow')" class="w-8 h-8 rounded-full bg-[#eab308] hover:ring-2 ring-offset-2 ring-[#eab308] transition-transform hover:scale-110 shadow-sm" aria-label="Yellow Theme"></button>
                        <button onclick="handleSetTheme('pink')" class="w-8 h-8 rounded-full bg-[#ec4899] hover:ring-2 ring-offset-2 ring-[#ec4899] transition-transform hover:scale-110 shadow-sm" aria-label="Pink Theme"></button>

                        <!-- Color Picker -->
                        <div class="relative w-8 h-8 rounded-full overflow-hidden hover:ring-2 ring-offset-2 ring-gray-400 transition-transform hover:scale-110 shadow-sm border border-gray-200">
                            <input type="color" id="custom-color-picker" onchange="handleSetCustomTheme(this.value)" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[150%] h-[150%] p-0 border-0 cursor-pointer" title="Eigene Farbe w√§hlen">
                            <i class="fas fa-plus absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-500 pointer-events-none text-xs"></i>
                        </div>
                    </div>
                </div>

                <div class="h-px bg-gray-200 w-full mb-6"></div>

                <!-- Method Section -->
                <div>
                    <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Berechnungsmethode</label>
                    <select id="method-select" onchange="changeMethod()" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-200">
                        <option value="3">Muslim World League (Standard f√ºr Europa)</option>
                        <option value="2">Islamic Society of North America (ISNA)</option>
                        <option value="4">Umm Al-Qura University, Makkah</option>
                        <option value="5">Egyptian General Authority of Survey</option>
                        <option value="13">Diyanet ƒ∞≈üleri Ba≈ükanlƒ±ƒüƒ±, T√ºrkei</option>
                        <option value="12">Union Organization islamic de France</option>
                        <option value="1">University of Islamic Sciences, Karachi</option>
                        <option value="0">Shia Ithna-Ashari, Leva Institute, Qum</option>
                        <option value="7">Institute of Geophysics, University of Tehran</option>
                        <option value="8">Gulf Region</option>
                        <option value="9">Kuwait</option>
                        <option value="10">Qatar</option>
                        <option value="11">Majlis Ugama Islam Singapura</option>
                        <option value="14">Spiritual Administration of Muslims of Russia</option>
                    </select>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">Diese Einstellung beeinflusst haupts√§chlich Fajr- und Isha-Zeiten.</p>
                </div>
            </div>

            <!-- Today's Times Cards -->
            <div class="glass-card rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-gray-50 dark:bg-slate-700/50 border-b border-gray-100 dark:border-gray-700 p-4 flex justify-between items-center">
                    <h2 class="font-bold text-gray-700 dark:text-gray-200">
                        <i class="far fa-calendar-alt mr-2 text-primary-500"></i>Heute
                        <span id="today-gregorian" class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-1"></span>
                    </h2>
                    <span class="text-xs bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 px-2 py-1 rounded-full" id="hijri-date">Hijri Datum</span>
                </div>

                <div class="divide-y divide-gray-100 dark:divide-gray-700" id="prayer-list">
                    <!-- Prayer Items will be injected here -->
                    <div class="p-4 text-center text-gray-500 dark:text-gray-400">Daten werden geladen...</div>
                </div>
            </div>

            <!-- 99 Names Card -->
            <a href="99names.html" class="block mt-6 glass-card rounded-2xl shadow-lg p-6 flex items-center justify-between hover:scale-[1.02] transition-transform duration-300 group">
                <div class="flex items-center gap-4">
                     <div class="w-12 h-12 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-primary-600 dark:text-primary-400 group-hover:bg-primary-500 group-hover:text-white transition-colors">
                        <i class="fas fa-star text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg">99 Namen Allahs</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Entdecke die sch√∂nen Namen und ihre Bedeutung</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-400 group-hover:text-primary-500 transition-colors"></i>
            </a>

            <!-- Hadith Card -->
            <a href="hadith.html" class="block mt-4 glass-card rounded-2xl shadow-lg p-6 flex items-center justify-between hover:scale-[1.02] transition-transform duration-300 group">
                <div class="flex items-center gap-4">
                     <div class="w-12 h-12 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-primary-600 dark:text-primary-400 group-hover:bg-primary-500 group-hover:text-white transition-colors">
                        <i class="fas fa-book-open text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg">Hadith Sammlung</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Sahih Bukhari, Muslim & mehr</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-400 group-hover:text-primary-500 transition-colors"></i>
            </a>

            <!-- Quran Viewer Card -->
            <a href="quran.html" class="block mt-4 glass-card rounded-2xl shadow-lg p-6 flex items-center justify-between hover:scale-[1.02] transition-transform duration-300 group">
                <div class="flex items-center gap-4">
                     <div class="w-12 h-12 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-primary-600 dark:text-primary-400 group-hover:bg-primary-500 group-hover:text-white transition-colors">
                        <i class="fas fa-quran text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg">Der Heilige Koran</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Lesen & H√∂ren (Maher Al Muaiqly)</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-400 group-hover:text-primary-500 transition-colors"></i>
            </a>

            <!-- Fajr Info Disclaimer -->
            <div class="mx-2 mt-4 px-2">
                 <p class="text-[10px] md:text-xs text-gray-400 dark:text-gray-500 text-center leading-relaxed max-w-2xl mx-auto">
                    <i class="fas fa-info-circle mr-1"></i>
                    Das Fajr-Gebet beginnt mit der Morgend√§mmerung (wenn der Himmel zu leuchten beginnt) und die Zeit endet genau in dem Moment, wenn die Sonne den Horizont √ºberschreitet, also mit dem Sonnenaufgang, wobei es als sicherer gilt, es kurz davor zu beten.
                </p>
            </div>

            <!-- Monthly Calendar View -->
            <div class="glass-card rounded-2xl shadow-lg overflow-hidden mt-6">
                 <div class="bg-gray-50 dark:bg-slate-700/50 border-b border-gray-100 dark:border-gray-700 p-4 flex justify-between items-center flex-wrap gap-2">
                    <h2 class="font-bold text-gray-700 dark:text-gray-200"><i class="fas fa-table mr-2 text-primary-500"></i>Monats√ºbersicht</h2>

                    <!-- Month Navigation -->
                    <div class="flex items-center gap-2 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600 p-1">
                        <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300 transition">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="month-display" class="text-sm font-semibold w-32 text-center text-gray-700 dark:text-gray-200 select-none">Lade...</span>
                        <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300 transition">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <!-- Adjusted table for mobile responsiveness -->
                    <table class="w-full text-xs md:text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-slate-700/50">
                            <tr>
                                <th scope="col" class="px-2 py-3 md:px-4">Tag</th>
                                <th scope="col" class="px-1 py-3 md:px-4 text-center">Fajr</th>
                                <th scope="col" class="px-1 py-3 md:px-4 text-center">Dhuhr</th>
                                <th scope="col" class="px-1 py-3 md:px-4 text-center">Asr</th>
                                <th scope="col" class="px-1 py-3 md:px-4 text-center">Maghrib</th>
                                <th scope="col" class="px-1 py-3 md:px-4 text-center">Isha</th>
                            </tr>
                        </thead>
                        <tbody id="month-table-body">
                            <!-- Rows injected via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white dark:bg-slate-900 border-t border-gray-200 dark:border-gray-800 mt-auto py-6">
        <div class="max-w-2xl mx-auto text-center px-4">
            <p class="text-xs text-gray-400 dark:text-gray-600">Datenquelle: Aladhan API.</p>

            <!-- iOS Scriptable Widget Button (Copy Feature) -->
            <div class="mt-4">
                <button id="copy-widget-btn" onclick="copyScriptableCode()"
                   class="inline-flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300 text-xs font-medium rounded-lg transition border border-slate-200 dark:border-slate-700 cursor-pointer">
                    <i class="fas fa-mobile-alt"></i>
                    <span id="copy-btn-text">iOS Scriptable Widget Code kopieren</span>
                </button>
            </div>

            <p class="text-xs text-gray-400 dark:text-gray-600 mt-4">&copy; 2026 Gebetszeiten App - s4nid</p>
        </div>
    </footer>

    <script src="theme.js"></script>
    <script src="transition.js"></script>
    <script>
        // --- Configuration & State ---
        // Fallback, falls Erkennung fehlschl√§gt
        const DEFAULT_LOCATION = {
            name: "Berlin",
            lat: 52.5200,
            lng: 13.4050
        };

        const DEFAULT_METHOD = 3; // Muslim World League

        // THEMES, generatePalette etc. are now in theme.js

        // Standard Prayer names mapping for German UI
        const PRAYER_NAMES = {
            Fajr: "Fajr (Morgend√§mmerung)",
            Sunrise: "Sonnenaufgang",
            Dhuhr: "Dhuhr (Mittag)",
            Asr: "Asr (Nachmittag)",
            Maghrib: "Maghrib (Abend)",
            Isha: "Isha (Nacht)"
        };

        // Sunrise hinzugef√ºgt, damit der Countdown das Ende von Fajr anzeigt und die App dann aktualisiert
        const TRACKED_PRAYERS = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

        let appState = {
            theme: 'emerald',
            customColor: null,
            darkMode: false,
            location: null,
            method: DEFAULT_METHOD,
            timings: null,
            nextPrayer: null,
            currentPrayer: null, // Neu: F√ºr die Hervorhebung
            viewDate: new Date(), // Neu: F√ºr die Kalender-Navigation
            adhanEnabled: false,
            adhanOffset: 10,
            fajrAdhanEnabled: false, // New: Special Fajr toggle
            notificationsEnabled: false, // NEU: Notifications State
            adhanPlayedFor: null // Stores the time/ID of the prayer we just played for
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            updateDateDisplay();
            updateMonthDisplay(); // Initiale Anzeige f√ºr Monatsnav
            loadSettings(); // Loads method, location, adhan settings, AND dark mode

            // Set up search enter key
            document.getElementById('city-search').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') searchCity();
            });

            // Update countdown every second
            setInterval(updateCountdown, 1000);

            // Audio Event Listener to update UI when audio ends
            const audio = document.getElementById('adhan-audio');
            audio.addEventListener('ended', () => {
                 updateAdhanUI(false);
            });
            audio.addEventListener('pause', () => {
                 updateAdhanUI(false);
            });
            audio.addEventListener('play', () => {
                 updateAdhanUI(true);
            });
        });

        function handleToggleDarkMode() {
            const isDark = window.toggleDarkMode();
            appState.darkMode = isDark;
        }

        function handleSetCustomTheme(hexColor) {
            const res = window.setCustomTheme(hexColor);
            appState.theme = res;
            appState.customColor = hexColor;
        }

        function handleSetTheme(themeName) {
            const res = window.setTheme(themeName);
            if (res) appState.theme = res;
        }

        function loadSettings() {
            // 0. Load Theme & Dark Mode
            const themeSettings = window.loadThemeSettings();
            appState.darkMode = themeSettings.isDark;
            appState.theme = themeSettings.currentTheme;
            appState.customColor = themeSettings.currentCustomColor;

            // 1. Load Method
            const savedMethod = localStorage.getItem('prayerAppMethod');
            if (savedMethod) {
                appState.method = parseInt(savedMethod);
            }
            document.getElementById('method-select').value = appState.method;

            // 2. Load Adhan Settings
            const savedAdhan = localStorage.getItem('prayerAppAdhan');
            if (savedAdhan) {
                const parsed = JSON.parse(savedAdhan);
                appState.adhanEnabled = parsed.enabled;
                appState.adhanOffset = parsed.offset;
                appState.fajrAdhanEnabled = parsed.fajrEnabled || false;
                appState.notificationsEnabled = parsed.notificationsEnabled || false;
            }
            document.getElementById('adhan-toggle').checked = appState.adhanEnabled;
            document.getElementById('adhan-offset-input').value = appState.adhanOffset;
            document.getElementById('fajr-adhan-toggle').checked = appState.fajrAdhanEnabled;

            // Checkbox Status setzen (nur wenn Permission auch wirklich da ist oder wir sie wollen)
            if (Notification.permission === 'granted' && appState.notificationsEnabled) {
                document.getElementById('notification-toggle').checked = true;
            } else {
                // Falls Permission entzogen wurde, aber State true war, resetten
                appState.notificationsEnabled = false;
                document.getElementById('notification-toggle').checked = false;
            }

            // Show/Hide player based on setting
            updatePlayerVisibility();

            // 3. Load Location
            const savedLocation = localStorage.getItem('prayerAppLocation');
            if (savedLocation) {
                appState.location = JSON.parse(savedLocation);
                document.getElementById('location-name').innerText = appState.location.name;
                // Location exists, fetch data
                fetchPrayerData();
            } else {
                // No location -> Auto Detect
                document.getElementById('location-name').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                detectLocation();
            }
        }

        function toggleSettings() {
            const el = document.getElementById('settings-panel');
            el.classList.toggle('hidden');
        }

        // --- Adhan Logic ---

        function toggleNotifications() {
            const toggle = document.getElementById('notification-toggle');

            if (toggle.checked) {
                // Request Permission
                if (!("Notification" in window)) {
                    alert("Dieser Browser unterst√ºtzt keine Desktop-Benachrichtigungen.");
                    toggle.checked = false;
                    return;
                }

                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        appState.notificationsEnabled = true;
                        new Notification("Benachrichtigungen aktiviert", {
                            body: "Du erh√§ltst nun Erinnerungen zu den Gebetszeiten.",
                            icon: "https://cdn-icons-png.flaticon.com/512/5968/5968282.png" // Beispiel Icon oder leer lassen
                        });
                        saveAdhanSettings();
                    } else {
                        appState.notificationsEnabled = false;
                        toggle.checked = false;
                        alert("Berechtigung verweigert. Bitte in den Browsereinstellungen aktivieren.");
                    }
                });
            } else {
                appState.notificationsEnabled = false;
                saveAdhanSettings();
            }
        }

        function saveAdhanSettings() {
            const enabled = document.getElementById('adhan-toggle').checked;
            const offset = parseInt(document.getElementById('adhan-offset-input').value) || 10;
            const fajrEnabled = document.getElementById('fajr-adhan-toggle').checked;
            // notification state is managed in toggleNotifications but saved here too for persistence

            appState.adhanEnabled = enabled;
            appState.adhanOffset = offset;
            appState.fajrAdhanEnabled = fajrEnabled;

            localStorage.setItem('prayerAppAdhan', JSON.stringify({
                enabled: enabled,
                offset: offset,
                fajrEnabled: fajrEnabled,
                notificationsEnabled: appState.notificationsEnabled
            }));

            // Toggle UI player
            updatePlayerVisibility();
        }

        function updatePlayerVisibility() {
            const container = document.getElementById('player-container');
            if (appState.adhanEnabled) {
                container.classList.remove('hidden');
                container.classList.add('flex');
            } else {
                container.classList.add('hidden');
                container.classList.remove('flex');
                // Also stop audio if playing and disabled
                const audio = document.getElementById('adhan-audio');
                if(!audio.paused) {
                    audio.pause();
                    audio.currentTime = 0;
                }
            }
        }

        function toggleAdhanPlayback() {
            const audio = document.getElementById('adhan-audio');
            if (audio.paused) {
                // Manually play checks default source if none set, but usually updateCountdown sets source.
                // If manual play is requested, let's set the default source if empty
                if (!audio.src || audio.src === window.location.href) {
                     audio.src = "https://cdn.aladhan.com/audio/adhans/a11-mansour-al-zahrani.mp3";
                }
                audio.play();
            } else {
                audio.pause();
                audio.currentTime = 0;
            }
        }

        function updateAdhanUI(isPlaying) {
            const iconContainer = document.getElementById('play-icon-container');
            const icon = iconContainer.querySelector('i');
            const statusText = document.getElementById('adhan-status-text');

            if (isPlaying) {
                icon.className = "fas fa-pause ml-0 text-sm"; // Remove ml-1 for center alignment
                iconContainer.className = "w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600 animate-pulse";
                statusText.innerText = "Spielt ab...";
                statusText.className = "text-xs font-bold text-primary-600";
            } else {
                icon.className = "fas fa-play ml-1 text-sm";
                iconContainer.className = "w-8 h-8 rounded-full bg-primary-100 flex items-center justify-center text-primary-600";
                statusText.innerText = appState.adhanEnabled ? `${appState.adhanOffset} Min. vor Gebet` : "Inaktiv";
                statusText.className = "text-xs font-medium";
            }
        }

        // --- Settings Logic ---

        function changeMethod() {
            const select = document.getElementById('method-select');
            const newMethod = select.value;
            appState.method = newMethod;
            localStorage.setItem('prayerAppMethod', newMethod);

            // Refetch data with new method if we have a location
            if (appState.location) {
                // Visual feedback
                document.getElementById('prayer-list').innerHTML = '<div class="p-4 text-center text-primary-600"><i class="fas fa-sync fa-spin mr-2"></i>Aktualisiere Zeiten...</div>';
                fetchPrayerData();
            }
        }

        function updateDateDisplay() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date-display').innerText = now.toLocaleDateString('de-DE', options);

            // Update Gregorian date next to "Heute"
            const shortOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
            const shortDate = now.toLocaleDateString('de-DE', shortOptions);
            const todayEl = document.getElementById('today-gregorian');
            if (todayEl) {
                todayEl.innerText = `(${shortDate})`;
            }
        }

        // --- Month Navigation Logic ---

        function changeMonth(offset) {
            // √Ñndere das Datum im State
            const currentView = appState.viewDate;
            currentView.setMonth(currentView.getMonth() + offset);
            appState.viewDate = new Date(currentView); // Trigger update mit neuem Objekt

            updateMonthDisplay();

            // Lade Daten f√ºr den neuen Monat
            if (appState.location) {
                document.getElementById('month-table-body').innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="loader mx-auto"></div></td></tr>';
                fetchPrayerData();
            }
        }

        function updateMonthDisplay() {
            const options = { month: 'long', year: 'numeric' };
            document.getElementById('month-display').innerText = appState.viewDate.toLocaleDateString('de-DE', options);
        }

        // --- Location Logic ---

        function saveLocation(name, lat, lng) {
            appState.location = { name, lat, lng };
            localStorage.setItem('prayerAppLocation', JSON.stringify(appState.location));

            document.getElementById('location-name').innerText = name;

            // Close settings only if opened (simple toggle logic might need care, but fine here)
            // Ideally we check if it's visible.
            const settingsPanel = document.getElementById('settings-panel');
            if(!settingsPanel.classList.contains('hidden')) {
                settingsPanel.classList.add('hidden');
            }

            fetchPrayerData();
        }

        // 1. Browser Geolocation
        function detectLocation() {
            const loader = document.getElementById('location-loading');
            loader.classList.remove('hidden');
            loader.classList.add('flex');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        reverseGeocode(lat, lng);
                    },
                    (error) => {
                        console.warn("Browser geo failed", error);
                        detectLocationViaIP();
                    }
                );
            } else {
                detectLocationViaIP();
            }
        }

        // 2. IP Geolocation Fallback
        async function detectLocationViaIP() {
            try {
                const response = await fetch('https://ipwho.is/');
                const data = await response.json();

                if (data.success) {
                    saveLocation(data.city, data.latitude, data.longitude);
                } else {
                    throw new Error("IP Location failed");
                }
            } catch (e) {
                console.error("Standort fehlgeschlagen", e);
                if (!appState.location) {
                    saveLocation(DEFAULT_LOCATION.name, DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lng);
                    alert("Standort nicht ermittelbar. Berlin geladen.");
                }
            } finally {
                const loader = document.getElementById('location-loading');
                loader.classList.remove('flex');
                loader.classList.add('hidden');
            }
        }

        // Reverse Geocode
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                const city = data.address.city || data.address.town || data.address.village || "Mein Standort";
                saveLocation(city, lat, lng);
            } catch (e) {
                saveLocation("Mein Standort", lat, lng);
            } finally {
                const loader = document.getElementById('location-loading');
                loader.classList.remove('flex');
                loader.classList.add('hidden');
            }
        }

        // Manual Search
        async function searchCity() {
            const query = document.getElementById('city-search').value;
            if (!query) return;

            const btn = document.querySelector('#settings-panel button'); // Gets the first button in panel (search)
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>';

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data && data.length > 0) {
                    saveLocation(data[0].name, parseFloat(data[0].lat), parseFloat(data[0].lon));
                    document.getElementById('city-search').value = '';
                } else {
                    alert('Stadt nicht gefunden.');
                }
            } catch (e) {
                console.error(e);
                alert('Fehler bei der Suche.');
            } finally {
                btn.innerHTML = originalHTML;
            }
        }

        // --- Aladhan API Integration ---

        async function fetchPrayerData() {
            if (!appState.location) return;

            // Nutze appState.viewDate statt new Date() f√ºr die Abfrage
            const viewDate = appState.viewDate;
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth() + 1;

            // Use the selected method
            const method = appState.method || DEFAULT_METHOD;

            const url = `https://api.aladhan.com/v1/calendar/${year}/${month}?latitude=${appState.location.lat}&longitude=${appState.location.lng}&method=${method}&school=1`;

            try {
                const response = await fetch(url);
                const json = await response.json();

                if (json.code === 200 && json.data) {
                    processAPIData(json.data);
                } else {
                     throw new Error("API returned no data or error code");
                }
            } catch (e) {
                console.error("API Error", e);
                document.getElementById('prayer-list').innerHTML = '<div class="p-4 text-red-500 text-center">Fehler beim Laden der Daten. <br><span class="text-xs">Bitte √ºberpr√ºfe deine Internetverbindung oder versuche es sp√§ter erneut.</span></div>';
                document.getElementById('month-table-body').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Keine Daten verf√ºgbar</td></tr>';
            }
        }

        function processAPIData(data) {
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            // Check ob die geladenen Daten dem aktuellen realen Monat entsprechen
            // API gibt Datum im gregorian object zur√ºck
            if (data.length > 0) {
                const dataMonth = parseInt(data[0].date.gregorian.month.number);
                const dataYear = parseInt(data[0].date.gregorian.year);

                const isCurrentMonth = (dataMonth === currentMonth && dataYear === currentYear);

                // NUR wenn wir im aktuellen Monat sind, aktualisieren wir die "Heute" Ansicht
                if (isCurrentMonth) {
                    const todayDate = now.getDate();
                    const todayData = data.find(d => parseInt(d.date.gregorian.day) === todayDate);

                    if (todayData) {
                        appState.timings = todayData.timings;

                        const hijri = todayData.date.hijri;
                        document.getElementById('hijri-date').innerText = `${hijri.day} ${hijri.month.en} ${hijri.year}`;

                        updatePrayerStates(appState.timings);
                        renderTodayList(appState.timings);
                    }
                }
            }

            // Die Kalendertabelle wird IMMER aktualisiert mit den geladenen Daten
            renderMonthTable(data);

            // Fallback: Wenn wir keine Timings f√ºr "Heute" gefunden haben (z.B. Monat gewechselt oder Daten fehlen)
            // und die Liste noch "Daten werden geladen..." anzeigt, dann leeren oder Hinweis zeigen.
            const prayerList = document.getElementById('prayer-list');
            if (prayerList.innerText.includes('Daten werden geladen')) {
                 // Wir sind nicht im aktuellen Monat oder haben keine Daten f√ºr heute gefunden.
                 // Zeige entweder die Daten des ersten Tages des Monats (als Beispiel) oder einen Hinweis.
                 if (data.length > 0) {
                     // Option: Zeige Daten vom 1. des geladenen Monats als "Vorschau" (optional)
                     // F√ºr jetzt: Einfach Hinweis
                     prayerList.innerHTML = '<div class="p-4 text-center text-gray-500">Zeige Zeiten f√ºr ' + appState.viewDate.toLocaleDateString('de-DE', {month: 'long', year: 'numeric'}) + '</div>';
                 } else {
                     prayerList.innerHTML = '<div class="p-4 text-center text-gray-500">Keine Daten verf√ºgbar.</div>';
                 }
            }
        }

        function parseTime(timeStr) {
            return timeStr.split(' ')[0];
        }

        // Neue Logik f√ºr Status & Countdown
        function updatePrayerStates(timings) {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();

            // 1. N√§chstes Gebet finden (f√ºr Countdown)
            // Wir schauen nur nach den Gebeten f√ºr den Countdown (TRACKED_PRAYERS)
            let foundNext = false;
            for (let prayer of TRACKED_PRAYERS) {
                const timeRaw = parseTime(timings[prayer]);
                const [h, m] = timeRaw.split(':').map(Number);
                const prayerMinutes = h * 60 + m;

                if (prayerMinutes > currentTime) {
                    appState.nextPrayer = {
                        name: prayer,
                        time: timeRaw,
                        obj: new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m)
                    };
                    foundNext = true;
                    break;
                }
            }

            if (!foundNext) {
                const fajrRaw = parseTime(timings['Fajr']);
                const [h, m] = fajrRaw.split(':').map(Number);
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(h, m, 0, 0);

                appState.nextPrayer = {
                    name: 'Fajr',
                    time: fajrRaw,
                    obj: tomorrow
                };
            }

            document.getElementById('next-prayer-name').innerText = PRAYER_NAMES[appState.nextPrayer.name];

            // 2. Aktuelles Gebet finden (f√ºr Hervorhebung in der Liste)
            // Hier nutzen wir alle Events inkl. Sunrise, damit die Markierung korrekt weiterspringt
            const allEvents = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            let current = null;

            for (let event of allEvents) {
                const timeRaw = parseTime(timings[event]);
                const [h, m] = timeRaw.split(':').map(Number);
                const eventMinutes = h * 60 + m;

                if (eventMinutes <= currentTime) {
                    current = event; // Merke das letzte Event, das <= jetzt ist
                }
            }

            // SONDERFALL: Nach Sonnenaufgang direkt auf Dhuhr switchen
            // Da Fajr nur bis Sonnenaufgang geht, springt das Highlight danach direkt auf das n√§chste Pflichtgebet (Dhuhr)
            if (current === 'Sunrise') {
                current = 'Dhuhr';
            }

            appState.currentPrayer = current;
        }

        function updateCountdown() {
            if (!appState.nextPrayer) return;

            const now = new Date();
            const diff = appState.nextPrayer.obj - now;

            if (diff <= 0) {
                // Wenn wir den Monat gewechselt haben und der Countdown abl√§uft,
                // wollen wir eigentlich die "echten" Daten neu laden.
                // Da fetchPrayerData nun viewDate nutzt, setzen wir viewDate kurz zur√ºck oder laden separat.
                // Einfacher Hack: Wir setzen viewDate auf Heute zur√ºck, damit der User sieht dass ein neuer Tag ist.
                // Oder wir lassen es so, dann aktualisiert sich nur der Countdown falls m√∂glich.
                // Beste UX: Seite neu laden oder current data neu fetchen.

                // Wir resetten hier viewDate auf current date um sicherzugehen dass "Heute" aktualisiert wird
                appState.viewDate = new Date();
                updateMonthDisplay();
                fetchPrayerData();
                return;
            }

            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('countdown').innerText =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // --- Check for Adhan Trigger & Notification ---
            // Only if (Audio OR Notification) enabled AND next prayer is NOT sunrise
            const isTriggerEnabled = appState.adhanEnabled || appState.notificationsEnabled;

            if (isTriggerEnabled && appState.nextPrayer && appState.nextPrayer.name !== 'Sunrise') {

                // Calculate trigger time: Prayer Time - Offset Minutes
                const prayerTimeMs = appState.nextPrayer.obj.getTime();
                const offsetMs = appState.adhanOffset * 60 * 1000;
                const triggerTimeMs = prayerTimeMs - offsetMs;

                // Current time
                const nowMs = now.getTime();

                // We check if we are within a 2-second window of the trigger time (to handle tick skip)
                // AND ensure we haven't played for this specific prayer instance yet.
                // Using a simple identifier: "PrayerName-Day"
                const prayerId = `${appState.nextPrayer.name}-${appState.nextPrayer.obj.getDate()}`;

                if (nowMs >= triggerTimeMs && nowMs < triggerTimeMs + 2000) {
                    if (appState.adhanPlayedFor !== prayerId) {

                        // 1. Audio Playback
                        if (appState.adhanEnabled) {
                            const audio = document.getElementById('adhan-audio');

                            // Dynamically set source based on prayer and settings
                            let src = "https://cdn.aladhan.com/audio/adhans/a11-mansour-al-zahrani.mp3"; // Default

                            if (appState.nextPrayer.name === 'Fajr' && appState.fajrAdhanEnabled) {
                                src = "https://cdn.aladhan.com/audio/adhans/fajr/f2-mansour-al-zahrani.mp3";
                            }

                            audio.src = src;
                            audio.play().catch(e => {
                                console.log("Autoplay blocked or error:", e);
                            });
                        }

                        // 2. System Notification
                        if (appState.notificationsEnabled && Notification.permission === "granted") {
                            const prayerName = PRAYER_NAMES[appState.nextPrayer.name];
                            const timeStr = parseTime(appState.timings[appState.nextPrayer.name]);

                            new Notification(`Gebetszeit: ${prayerName}`, {
                                body: `Es ist bald Zeit f√ºr das Gebet (${timeStr}).`,
                                icon: "https://img.icons8.com/color/96/mosque.png", // Free icon for context
                                requireInteraction: true // Bleibt sichtbar bis Interaktion (auf manchen Systemen)
                            });
                        }

                        appState.adhanPlayedFor = prayerId;
                    }
                }
            }
        }

        function renderTodayList(timings) {
            const container = document.getElementById('prayer-list');
            container.innerHTML = '';

            const order = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

            order.forEach(key => {
                const time = parseTime(timings[key]);
                // √ÑNDERUNG: Pr√ºfe auf currentPrayer statt nextPrayer
                const isActive = appState.currentPrayer === key;

                let icon = 'fa-clock';
                if(key === 'Fajr') icon = 'fa-cloud-sun';
                if(key === 'Sunrise') icon = 'fa-sun';
                if(key === 'Dhuhr') icon = 'fa-sun';
                if(key === 'Asr') icon = 'fa-cloud-sun';
                if(key === 'Maghrib') icon = 'fa-moon';
                if(key === 'Isha') icon = 'fa-star';

                const html = `
                    <div class="flex justify-between items-center p-4 transition-all duration-300 ${isActive ? 'prayer-active' : 'hover:bg-gray-50 dark:hover:bg-white/5'}">
                        <div class="flex items-center gap-3">
                            <div class="w-8 text-center"><i class="fas ${icon} ${isActive ? 'text-white' : 'text-primary-500'}"></i></div>
                            <span class="font-medium">${PRAYER_NAMES[key] || key}</span>
                        </div>
                        <span class="font-bold font-mono text-lg">${time}</span>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function renderMonthTable(data) {
            const tbody = document.getElementById('month-table-body');
            tbody.innerHTML = '';

            const now = new Date();
            const currentDay = now.getDate();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            // Datenmonat ermitteln f√ºr Highlighting
            const dataMonth = parseInt(data[0].date.gregorian.month.number);
            const dataYear = parseInt(data[0].date.gregorian.year);
            const isCurrentMonthView = (dataMonth === currentMonth && dataYear === currentYear);

            data.forEach(day => {
                const t = day.timings;
                const d = day.date.gregorian;
                const dayNum = parseInt(d.day);

                // Highlight nur wenn es wirklich heute ist (Tag + Monat + Jahr stimmen)
                const isToday = isCurrentMonthView && (dayNum === currentDay);

                // Responsive padding and hidden month name on mobile
                const row = `
                    <tr class="border-b dark:border-gray-700 ${isToday ? 'bg-primary-100 dark:bg-primary-900/30 font-semibold' : 'hover:bg-gray-50 dark:hover:bg-white/5'}">
                        <td class="px-2 py-2 md:px-4 md:py-3 whitespace-nowrap">${d.day}. <span class="hidden sm:inline">${d.month.en.slice(0,3)}</span></td>
                        <td class="px-1 py-2 md:px-4 md:py-3 text-center">${parseTime(t.Fajr)}</td>
                        <td class="px-1 py-2 md:px-4 md:py-3 text-center">${parseTime(t.Dhuhr)}</td>
                        <td class="px-1 py-2 md:px-4 md:py-3 text-center">${parseTime(t.Asr)}</td>
                        <td class="px-1 py-2 md:px-4 md:py-3 text-center">${parseTime(t.Maghrib)}</td>
                        <td class="px-1 py-2 md:px-4 md:py-3 text-center">${parseTime(t.Isha)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- Copy Logic for Scriptable Code ---
        function copyScriptableCode() {
            // The user provided code block for Scriptable
            const code = `// Prayer Times Widget
// Generated Code

const DEFAULT = {
¬† city: "Berlin",
¬† country: "Germany",
¬† method: 3
};

// --- FARBPALETTE ---
const COLORS = {
¬† "gr√ºn": "#10b981",
¬† "green": "#10b981",
¬† "emerald": "#10b981",
¬† "blau": "#3b82f6",
¬† "blue": "#3b82f6",
¬† "t√ºrkis": "#06b6d4",
¬† "cyan": "#06b6d4",
¬† "rot": "#ef4444",
¬† "red": "#ef4444",
¬† "pink": "#ec4899",
¬† "magenta": "#d946ef",
¬† "lila": "#8b5cf6",
¬† "purple": "#8b5cf6",
¬† "orange": "#f97316",
¬† "gelb": "#eab308",
¬† "yellow": "#eab308",
¬† "grau": "#6b7280",
¬† "gray": "#6b7280"
};

// Fallback Farbe
let THEME_COLOR_HEX = "#10b981";

// --- PARAMETER LOGIC ---
let cityParam = DEFAULT.city;

if (args.widgetParameter) {
¬† const params = args.widgetParameter.split(",");
¬† if (params[0] && params[0].trim() !== "") {
¬† ¬† cityParam = params[0].trim();
¬† }
¬† for (let i = 1; i < params.length; i++) {
¬† ¬† let p = params[i].trim();
¬† ¬† if (p === "") continue;
¬† ¬† if (!isNaN(p)) {
¬† ¬† ¬† DEFAULT.method = parseInt(p);
¬† ¬† ¬† continue;
¬† ¬† }
¬† ¬† let lowerC = p.toLowerCase();
¬† ¬† if (COLORS[lowerC]) {
¬† ¬† ¬† THEME_COLOR_HEX = COLORS[lowerC];
¬† ¬† } else if (lowerC.startsWith("#")) {
¬† ¬† ¬† THEME_COLOR_HEX = lowerC;
¬† ¬† }
¬† }
}

// Colors
const THEME_COLOR = new Color(THEME_COLOR_HEX);
const BG_TOP = getDarkVariant(THEME_COLOR_HEX, 0.2);¬†
const BG_BOT = getDarkVariant(THEME_COLOR_HEX, 0.1);¬†

// Init Widget
const widget = new ListWidget();
const gradient = new LinearGradient();
gradient.colors = [BG_TOP, BG_BOT];
gradient.locations = [0, 1];
widget.backgroundGradient = gradient;

try {
¬† let now = new Date();
¬† let data = await fetchPrayerData(now, cityParam);
¬† let timings = data.timings;
¬†¬†
¬† const ishaStr = timings['Isha'].split(' ')[0];
¬† const [h, m] = ishaStr.split(':').map(Number);
¬† const ishaDate = new Date(now);
¬† ishaDate.setHours(h, m, 0, 0);
¬†¬†
¬† let isNextDay = false;
¬† if (now > ishaDate) {
¬† ¬† ¬†const tomorrow = new Date(now);
¬† ¬† ¬†tomorrow.setDate(tomorrow.getDate() + 1);
¬† ¬† ¬†data = await fetchPrayerData(tomorrow, cityParam);
¬† ¬† ¬†timings = data.timings;
¬† ¬† ¬†isNextDay = true;
¬† }
¬†¬†
¬† const hijri = data.date.hijri;
¬† let next;
¬† if (isNextDay) {
¬† ¬† ¬†next = { name: 'Fajr', time: timings['Fajr'].split(' ')[0] };
¬† } else {
¬† ¬† ¬†next = getNextPrayerToday(timings);
¬† }
¬†¬†
¬† // --- RESPONSIVE UI ---
¬† const family = config.widgetFamily || "medium";
¬†¬†
¬† if (family === 'small') {
¬† ¬† ¬† renderSmall(widget, next, timings);
¬† } else if (family === 'accessoryRectangular') {
¬† ¬† ¬† // Lockscreen Rechteck
¬† ¬† ¬† renderRectangular(widget, next, timings);
¬† } else if (family === 'accessoryCircular') {
¬† ¬† ¬† // Lockscreen Rund
¬† ¬† ¬† renderCircular(widget, next);
¬† } else {
¬† ¬† ¬† renderMedium(widget, next, timings, hijri, cityParam);
¬† }
¬†¬†
¬† widget.refreshAfterDate = new Date(Date.now() + 60 * 60 * 1000);

} catch (e) {
¬† widget.addText("Err: " + e.message).textColor = Color.red();
}

Script.setWidget(widget);
Script.complete();

if (config.runsInApp) {
¬† ¬† if ("medium" === "small") {
¬† ¬† ¬† ¬† widget.presentSmall();
¬† ¬† } else {
¬† ¬† ¬† ¬† widget.presentMedium();
¬† ¬† }
}

// --- RENDER FUNCTIONS ---

// 1. LOCKSCREEN RECTANGULAR
function renderRectangular(w, next, timings) {
¬† ¬† const stack = w.addStack();
¬† ¬† stack.layoutHorizontally();
¬† ¬† stack.centerAlignContent();
¬† ¬†¬†
¬† ¬† // Left: Big Next Time
¬† ¬† const left = stack.addStack();
¬† ¬† left.layoutVertically();
¬† ¬† left.centerAlignContent();
¬† ¬†¬†
¬† ¬† const lbl = left.addText(mapName(next.name).toUpperCase());
¬† ¬† lbl.font = Font.boldSystemFont(9);
¬† ¬† lbl.textColor = Color.white();¬†
¬† ¬†¬†
¬† ¬† const time = left.addText(next.time);
¬† ¬† time.font = Font.boldSystemFont(22);¬†
¬† ¬† time.textColor = Color.white();
¬† ¬†¬†
¬† ¬† stack.addSpacer();
¬† ¬†¬†
¬† ¬† // Right: List (Very small)
¬† ¬† const right = stack.addStack();
¬† ¬† right.layoutVertically();
¬† ¬†¬†
¬† ¬† const prayers = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
¬† ¬† for(let p of prayers) {
¬† ¬† ¬† ¬† const row = right.addStack();
¬† ¬† ¬† ¬† row.layoutHorizontally();
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† // Highlight active
¬† ¬† ¬† ¬† const isActive = (p === next.name);
¬† ¬† ¬† ¬† const f = isActive ? Font.boldSystemFont(8) : Font.systemFont(8);
¬† ¬† ¬† ¬† // Dim inactive prayers heavily
¬† ¬† ¬† ¬† const opacity = isActive ? 1 : 0.5;
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† const n = row.addText(mapName(p).substr(0, 3));¬†
¬† ¬† ¬† ¬† n.font = f;
¬† ¬† ¬† ¬† n.textOpacity = opacity;
¬† ¬† ¬† ¬† n.textColor = Color.white();
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† row.addSpacer(4);
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† const t = row.addText(timings[p].split(' ')[0]);
¬† ¬† ¬† ¬† t.font = f;
¬† ¬† ¬† ¬† t.textOpacity = opacity;
¬† ¬† ¬† ¬† t.textColor = Color.white();
¬† ¬† }
}

// 2. LOCKSCREEN CIRCULAR
function renderCircular(w, next) {
¬† ¬† const stack = w.addStack();
¬† ¬† stack.layoutVertically();
¬† ¬† stack.centerAlignContent();
¬† ¬†¬†
¬† ¬† const t = stack.addText(next.time);
¬† ¬† t.font = Font.boldSystemFont(12);
¬† ¬† t.minimumScaleFactor = 0.5;
¬† ¬† t.textColor = Color.white();
¬† ¬† t.centerAlignText();
¬† ¬†¬†
¬† ¬† const n = stack.addText(mapName(next.name));
¬† ¬† n.font = Font.systemFont(8);
¬† ¬† n.textColor = Color.white();
¬† ¬† n.centerAlignText();
}

// 3. HOMESCREEN SMALL
function renderSmall(w, next, timings) {
¬† ¬† w.setPadding(12, 12, 12, 12);
¬† ¬†¬†
¬† ¬† const topStack = w.addStack();
¬† ¬† topStack.layoutVertically();
¬† ¬† topStack.centerAlignContent();¬†
¬† ¬†¬†
¬† ¬† const nextLabel = topStack.addText("N√ÑCHSTES GEBET: " + mapName(next.name).toUpperCase());
¬† ¬† nextLabel.font = Font.boldSystemFont(9);
¬† ¬† nextLabel.textColor = THEME_COLOR;
¬† ¬† nextLabel.centerAlignText();
¬† ¬†¬†
¬† ¬† const nextTime = topStack.addText(next.time);
¬† ¬† nextTime.font = Font.boldSystemFont(32);¬†
¬† ¬† nextTime.textColor = Color.white();
¬† ¬† nextTime.centerAlignText();
¬† ¬†¬†
¬† ¬† w.addSpacer(8);
¬† ¬†¬†
¬† ¬† const listStack = w.addStack();
¬† ¬† listStack.layoutVertically();
¬† ¬†¬†
¬† ¬† const prayers = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
¬† ¬†¬†
¬† ¬† for (let pName of prayers) {
¬† ¬† ¬† ¬† const pTime = timings[pName].split(' ')[0];
¬† ¬† ¬† ¬† const isActive = (pName === next.name);
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† const row = listStack.addStack();
¬† ¬† ¬† ¬† row.layoutHorizontally();
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† const nameT = row.addText(mapName(pName));
¬† ¬† ¬† ¬† nameT.font = isActive ? Font.boldSystemFont(9) : Font.systemFont(9);
¬† ¬† ¬† ¬† nameT.textColor = isActive ? THEME_COLOR : new Color("#888888");
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† row.addSpacer();
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† const timeT = row.addText(pTime);
¬† ¬† ¬† ¬† timeT.font = isActive ? Font.boldSystemFont(9) : Font.systemFont(9);
¬† ¬† ¬† ¬† timeT.textColor = isActive ? Color.white() : new Color("#cccccc");
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† listStack.addSpacer(2);
¬† ¬† }
}

// 4. HOMESCREEN MEDIUM
function renderMedium(w, next, timings, hijri, cityName) {
¬† const headerStack = w.addStack();
¬† headerStack.layoutHorizontally();
¬† headerStack.topAlignContent();¬†
¬†¬†
¬† const infoStack = headerStack.addStack();
¬† infoStack.layoutVertically();
¬†¬†
¬† const cityText = infoStack.addText(String(cityName));
¬† cityText.font = Font.boldSystemFont(14);
¬† cityText.textColor = Color.white();
¬†¬†
¬† const hijriText = infoStack.addText(\`\${hijri.day} \${hijri.month.en}\`);
¬† hijriText.font = Font.systemFont(10);
¬† hijriText.textColor = THEME_COLOR;
¬†¬†
¬† headerStack.addSpacer();
¬†¬†
¬† const nextStack = headerStack.addStack();
¬† nextStack.layoutVertically();
¬† nextStack.bottomAlignContent();¬†
¬†¬†
¬† const nextLabel = nextStack.addText("N√ÑCHSTES GEBET: " + mapName(next.name).toUpperCase());
¬† nextLabel.font = Font.boldSystemFont(10);
¬† nextLabel.textColor = THEME_COLOR;
¬† nextLabel.rightAlignText();
¬†¬†
¬† const nextTime = nextStack.addText(next.time);
¬† nextTime.font = Font.boldSystemFont(46);
¬† nextTime.textColor = Color.white();
¬† nextTime.rightAlignText();
¬†¬†
¬† w.addSpacer();
¬†¬†
¬† const listStack = w.addStack();
¬† listStack.layoutHorizontally();
¬† listStack.centerAlignContent();
¬†¬†
¬† const prayers = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
¬†¬†
¬† for (let i = 0; i < prayers.length; i++) {
¬† ¬† const pName = prayers[i];
¬† ¬† const pTime = timings[pName].split(' ')[0];
¬† ¬† const isActive = (pName === next.name);
¬† ¬† addPrayerItem(listStack, pName, pTime, isActive);
¬† ¬† if (i < prayers.length - 1) listStack.addSpacer();
¬† }
}

// --- HELPERS ---

async function fetchPrayerData(dateObj, city) {
¬† const dateStr = \`\${dateObj.getDate()}-\${dateObj.getMonth()+1}-\${dateObj.getFullYear()}\`;
¬†¬†
¬† let c = encodeURI(String(city));
¬† let co = encodeURI(String(DEFAULT.country));
¬† let m = String(DEFAULT.method);
¬†¬†
¬† const url = \`https://api.aladhan.com/v1/timingsByCity/\${dateStr}?city=\${c}&country=\${co}&method=\${m}&school=1\`;
¬† const req = new Request(url);
¬† return (await req.loadJSON()).data;
}

function getNextPrayerToday(timings) {
¬† const now = new Date();
¬† const currentMins = now.getHours() * 60 + now.getMinutes();
¬† const order = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
¬† for (let name of order) {
¬† ¬† const timeStr = timings[name].split(' ')[0];
¬† ¬† const [h, m] = timeStr.split(':').map(Number);
¬† ¬† const mins = h * 60 + m;
¬† ¬† if (mins > currentMins) return { name: name, time: timeStr };
¬† }
¬† return { name: 'Fajr', time: timings['Fajr'].split(' ')[0] };
}

function addPrayerItem(stack, name, time, isActive) {
¬† const itemStack = stack.addStack();
¬† itemStack.layoutVertically();
¬† itemStack.centerAlignContent();
¬†¬†
¬† const nameTxt = itemStack.addText(mapName(name));
¬† nameTxt.font = isActive ? Font.boldSystemFont(9) : Font.systemFont(9);
¬† nameTxt.textColor = isActive ? THEME_COLOR : new Color("#888888");
¬† nameTxt.centerAlignText();
¬† itemStack.addSpacer(2);
¬† const timeStack = itemStack.addStack();
¬† if (isActive) {
¬† ¬† timeStack.backgroundColor = new Color("#ffffff", 0.15);¬†
¬† ¬† timeStack.cornerRadius = 4;
¬† ¬† timeStack.setPadding(2, 4, 2, 4);
¬† }
¬† const timeTxt = timeStack.addText(time);
¬† timeTxt.font = isActive ? Font.boldSystemFont(11) : Font.mediumSystemFont(11);
¬† timeTxt.textColor = isActive ? Color.white() : new Color("#cccccc");
}

function mapName(key) {
¬† const map = { "Fajr": "Fajr", "Sunrise": "Shuruk", "Dhuhr": "Dhuhr", "Asr": "Asr", "Maghrib": "Maghrib", "Isha": "Isha" };
¬† return map[key] || key;
}

function getDarkVariant(hex, factor) {
¬† ¬†let c = new Color(hex);
¬† ¬†let r = Math.floor(c.red * factor * 255);
¬† ¬†let g = Math.floor(c.green * factor * 255);
¬† ¬†let b = Math.floor(c.blue * factor * 255);
¬† ¬†let toHex = (n) => ("0" + n.toString(16)).slice(-2);
¬† ¬†return new Color("#" + toHex(r) + toHex(g) + toHex(b));
}`;

            // Create hidden textarea to copy content (works better in iframes/webviews than navigator.clipboard)
            const el = document.createElement('textarea');
            el.value = code;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            // Visual feedback
            const btnText = document.getElementById('copy-btn-text');
            const originalText = btnText.innerText;
            const btn = document.getElementById('copy-widget-btn');

            btnText.innerText = "Code kopiert!";
            btn.classList.add('bg-primary-100', 'text-primary-700', 'border-primary-200');
            btn.classList.remove('bg-slate-100', 'text-slate-700', 'border-slate-200');

            // Revert after 2 seconds
            setTimeout(() => {
                btnText.innerText = originalText;
                btn.classList.remove('bg-primary-100', 'text-primary-700', 'border-primary-200');
                btn.classList.add('bg-slate-100', 'text-slate-700', 'border-slate-200');
            }, 2000);
        }
    </script>
</body>
</html>
