<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO Meta Tags -->
    <title>Gebetszeiten Deutschland & Weltweit - Kostenlos & PrÃ¤zise</title>
    <meta name="description" content="Aktuelle islamische Gebetszeiten fÃ¼r Berlin, Deutschland und weltweit. Genaue Zeiten fÃ¼r Fajr, Dhuhr, Asr, Maghrib und Isha mit automatischem Standort, Hijri-Datum und Countdown.">
    <meta name="keywords" content="Gebetszeiten, Namaz Zeit, Salah, Muslimische Gebetszeiten, Islam, Gebetskalender, Berlin, Deutschland, Fajr, Maghrib, Isha, Moschee, Gebet">
    <meta name="author" content="Gebetszeiten App">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://gebetszeiten.live/">
    <meta property="og:title" content="Gebetszeiten Deutschland & Weltweit">
    <meta property="og:description" content="PrÃ¤zise islamische Gebetszeiten fÃ¼r deinen Standort. Mit Countdown, MonatsÃ¼bersicht und Hijri-Datum.">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Gebetszeiten Deutschland & Weltweit">
    <meta property="twitter:description" content="PrÃ¤zise islamische Gebetszeiten fÃ¼r deinen Standort. Mit Countdown, MonatsÃ¼bersicht und Hijri-Datum.">

    <!-- PWA / Mobile Optimization -->
    <meta name="theme-color" content="#0f172a"> <!-- Dunkles Blau passend zum Header -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gebetszeiten">
    
    <!-- Inline Manifest for PWA (Data URI) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiR2ViZXRzemVpdGVuIEFwcCIsInNob3J0X25hbWUiOiJHZWJldHN6ZWl0ZW4iLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmM2Y0ZjYiLCJ0aGVtZV9jb2xvciI6IiMwZjE3MmEiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9jZG4tanRpZmYuYWxYcGxvcmVyLm5ldC9hc3NldHMvaWNvbnMvcHJheWVyLWFwcC1pY29uLTE5Mi5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn0seyJzcmMiOiJodHRwczovL2Nkbi1qdGlmZi5hbFhwbG9yZXIubmV0L2Fzc2V0cy9pY29ucy9wcmF5ZXItYXBwLWljb24tNTEyLnBuZyIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9wbmcifV19">
    
    <!-- Favicon (using emoji as fallback) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ•Œ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%230f172a%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2270%22>ðŸ•Œ</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* Prevent pull-to-refresh on mobile which looks weird in standalone mode */
            overscroll-behavior-y: none;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .prayer-active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #10b981;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800 antialiased min-h-screen flex flex-col">

    <!-- Header / Hero Section -->
    <header class="bg-slate-900 text-white pb-24 pt-8 px-4 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-10">
            <i class="fas fa-mosque absolute -bottom-10 -right-10 text-9xl"></i>
            <i class="far fa-star absolute top-10 left-10 text-4xl animate-pulse"></i>
        </div>

        <div class="max-w-2xl mx-auto relative z-10">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">Gebetszeiten</h1>
                    <p class="text-slate-400 text-sm" id="current-date-display">LÃ¤dt...</p>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="toggleSettings()" class="bg-slate-800 hover:bg-slate-700 py-2 px-3 rounded-full transition flex items-center shadow-lg border border-slate-700">
                        <i class="fas fa-map-marker-alt text-emerald-400"></i> 
                        <span id="location-name" class="ml-2 text-sm font-medium">Berlin</span>
                    </button>
                    <button onclick="toggleSettings()" class="bg-slate-800 hover:bg-slate-700 p-2 rounded-full transition w-10 h-10 flex items-center justify-center shadow-lg border border-slate-700" title="Einstellungen">
                        <i class="fas fa-cog text-slate-300 hover:text-white transition-colors"></i>
                    </button>
                </div>
            </div>

            <!-- Next Prayer Highlight -->
            <div class="text-center mt-6">
                <p class="text-slate-400 text-sm uppercase tracking-wider mb-1">NÃ¤chstes Gebet in</p>
                <div id="countdown" class="text-4xl md:text-5xl font-bold font-mono text-emerald-400 mb-2">--:--:--</div>
                <p id="next-prayer-name" class="text-xl font-medium text-white">LÃ¤dt...</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow px-4 -mt-16 relative z-20 pb-10">
        <div class="max-w-2xl mx-auto space-y-6">

            <!-- Settings Panel (Hidden by default) -->
            <div id="settings-panel" class="hidden glass-card rounded-2xl shadow-xl p-6 mb-6 animate-fade-in ring-1 ring-black/5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-gray-800">Einstellungen</h3>
                    <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
                
                <!-- Location Section -->
                <div class="mb-6">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Standort</label>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="city-search" placeholder="Stadt eingeben (z.B. KÃ¶ln)..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                        <button onclick="searchCity()" class="bg-slate-800 text-white px-4 py-2 rounded-lg hover:bg-slate-700">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <button onclick="detectLocation()" class="w-full py-2 border border-emerald-500 text-emerald-600 rounded-lg hover:bg-emerald-50 transition flex justify-center items-center gap-2 text-sm font-medium">
                        <i class="fas fa-location-arrow"></i> Meinen Standort verwenden
                    </button>
                    <div id="location-loading" class="hidden justify-center mt-2"><div class="loader"></div></div>
                </div>

                <div class="h-px bg-gray-200 w-full mb-6"></div>

                <!-- Method Section -->
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Berechnungsmethode</label>
                    <select id="method-select" onchange="changeMethod()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:outline-none bg-white text-gray-700">
                        <option value="3">Muslim World League (Standard fÃ¼r Europa)</option>
                        <option value="2">Islamic Society of North America (ISNA)</option>
                        <option value="4">Umm Al-Qura University, Makkah</option>
                        <option value="5">Egyptian General Authority of Survey</option>
                        <option value="13">Diyanet Ä°ÅŸleri BaÅŸkanlÄ±ÄŸÄ±, TÃ¼rkei</option>
                        <option value="12">Union Organization islamic de France</option>
                        <option value="1">University of Islamic Sciences, Karachi</option>
                        <option value="0">Shia Ithna-Ashari, Leva Institute, Qum</option>
                        <option value="7">Institute of Geophysics, University of Tehran</option>
                        <option value="8">Gulf Region</option>
                        <option value="9">Kuwait</option>
                        <option value="10">Qatar</option>
                        <option value="11">Majlis Ugama Islam Singapura</option>
                        <option value="14">Spiritual Administration of Muslims of Russia</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2">Diese Einstellung beeinflusst hauptsÃ¤chlich Fajr- und Isha-Zeiten.</p>
                </div>
            </div>

            <!-- Today's Times Cards -->
            <div class="glass-card rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-gray-50 border-b border-gray-100 p-4 flex justify-between items-center">
                    <h2 class="font-bold text-gray-700">
                        <i class="far fa-calendar-alt mr-2 text-emerald-500"></i>Heute 
                        <span id="today-gregorian" class="text-sm font-normal text-gray-500 ml-1"></span>
                    </h2>
                    <span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full" id="hijri-date">Hijri Datum</span>
                </div>
                
                <div class="divide-y divide-gray-100" id="prayer-list">
                    <!-- Prayer Items will be injected here -->
                    <div class="p-4 text-center text-gray-500">Daten werden geladen...</div>
                </div>
            </div>

            <!-- Fajr Info Disclaimer -->
            <div class="mx-2 mt-4 px-2">
                 <p class="text-[10px] md:text-xs text-gray-400 text-center leading-relaxed max-w-2xl mx-auto">
                    <i class="fas fa-info-circle mr-1"></i>
                    Das Fajr-Gebet beginnt mit der MorgendÃ¤mmerung (wenn der Himmel zu leuchten beginnt) und die Zeit endet genau in dem Moment, wenn die Sonne den Horizont Ã¼berschreitet, also mit dem Sonnenaufgang, wobei es als sicherer gilt, es kurz davor zu beten.
                </p>
            </div>

            <!-- Monthly Calendar View -->
            <div class="glass-card rounded-2xl shadow-lg overflow-hidden mt-6">
                 <div class="bg-gray-50 border-b border-gray-100 p-4 flex justify-between items-center flex-wrap gap-2">
                    <h2 class="font-bold text-gray-700"><i class="fas fa-table mr-2 text-emerald-500"></i>MonatsÃ¼bersicht</h2>
                    
                    <!-- Month Navigation -->
                    <div class="flex items-center gap-2 bg-white rounded-lg border border-gray-200 p-1">
                        <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-gray-600 transition">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="month-display" class="text-sm font-semibold w-32 text-center text-gray-700 select-none">Lade...</span>
                        <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-gray-600 transition">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <!-- Adjusted table for mobile responsiveness -->
                    <table class="w-full text-xs md:text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-2 py-3 md:px-4">Tag</th>
                                <th scope="col" class="px-1 py-3 md:px-4 text-center">Fajr</th>
                                <th scope="col" class="px-1 py-3 md:px-4 text-center">Dhuhr</th>
                                <th scope="col" class="px-1 py-3 md:px-4 text-center">Asr</th>
                                <th scope="col" class="px-1 py-3 md:px-4 text-center">Maghrib</th>
                                <th scope="col" class="px-1 py-3 md:px-4 text-center">Isha</th>
                            </tr>
                        </thead>
                        <tbody id="month-table-body">
                            <!-- Rows injected via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-auto py-6">
        <div class="max-w-2xl mx-auto text-center px-4">
            <p class="text-xs text-gray-400">Datenquelle: Aladhan API.</p>
            
            <!-- iOS Scriptable Widget Button (Copy Feature) -->
            <div class="mt-4">
                <button id="copy-widget-btn" onclick="copyScriptableCode()" 
                   class="inline-flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-medium rounded-lg transition border border-slate-200 cursor-pointer">
                    <i class="fas fa-mobile-alt"></i>
                    <span id="copy-btn-text">iOS Scriptable Widget Code kopieren</span>
                </button>
            </div>

            <p class="text-xs text-gray-400 mt-4">&copy; 2026 Gebetszeiten App - s4nid</p>
        </div>
    </footer>

    <script>
        // --- Configuration & State ---
        // Fallback, falls Erkennung fehlschlÃ¤gt
        const DEFAULT_LOCATION = {
            name: "Berlin",
            lat: 52.5200,
            lng: 13.4050
        };

        const DEFAULT_METHOD = 3; // Muslim World League

        // Standard Prayer names mapping for German UI
        const PRAYER_NAMES = {
            Fajr: "Fajr (MorgendÃ¤mmerung)",
            Sunrise: "Sonnenaufgang",
            Dhuhr: "Dhuhr (Mittag)",
            Asr: "Asr (Nachmittag)",
            Maghrib: "Maghrib (Abend)",
            Isha: "Isha (Nacht)"
        };

        // Sunrise hinzugefÃ¼gt, damit der Countdown das Ende von Fajr anzeigt und die App dann aktualisiert
        const TRACKED_PRAYERS = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

        let appState = {
            location: null,
            method: DEFAULT_METHOD,
            timings: null,
            nextPrayer: null,
            currentPrayer: null, // Neu: FÃ¼r die Hervorhebung
            viewDate: new Date() // Neu: FÃ¼r die Kalender-Navigation
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            updateDateDisplay();
            updateMonthDisplay(); // Initiale Anzeige fÃ¼r Monatsnav
            loadSettings();
            
            // Set up search enter key
            document.getElementById('city-search').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') searchCity();
            });

            // Update countdown every second
            setInterval(updateCountdown, 1000);
        });

        function loadSettings() {
            // 1. Load Method
            const savedMethod = localStorage.getItem('prayerAppMethod');
            if (savedMethod) {
                appState.method = parseInt(savedMethod);
            }
            // Set dropdown value
            document.getElementById('method-select').value = appState.method;

            // 2. Load Location
            const savedLocation = localStorage.getItem('prayerAppLocation');
            if (savedLocation) {
                appState.location = JSON.parse(savedLocation);
                document.getElementById('location-name').innerText = appState.location.name;
                // Location exists, fetch data
                fetchPrayerData();
            } else {
                // No location -> Auto Detect
                document.getElementById('location-name').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                detectLocation();
            }
        }

        function toggleSettings() {
            const el = document.getElementById('settings-panel');
            el.classList.toggle('hidden');
        }

        // --- Settings Logic ---

        function changeMethod() {
            const select = document.getElementById('method-select');
            const newMethod = select.value;
            appState.method = newMethod;
            localStorage.setItem('prayerAppMethod', newMethod);
            
            // Refetch data with new method if we have a location
            if (appState.location) {
                // Visual feedback
                document.getElementById('prayer-list').innerHTML = '<div class="p-4 text-center text-emerald-600"><i class="fas fa-sync fa-spin mr-2"></i>Aktualisiere Zeiten...</div>';
                fetchPrayerData();
            }
        }

        function updateDateDisplay() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date-display').innerText = now.toLocaleDateString('de-DE', options);
            
            // Update Gregorian date next to "Heute"
            const shortOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
            const shortDate = now.toLocaleDateString('de-DE', shortOptions);
            const todayEl = document.getElementById('today-gregorian');
            if (todayEl) {
                todayEl.innerText = `(${shortDate})`;
            }
        }

        // --- Month Navigation Logic ---

        function changeMonth(offset) {
            // Ã„ndere das Datum im State
            const currentView = appState.viewDate;
            currentView.setMonth(currentView.getMonth() + offset);
            appState.viewDate = new Date(currentView); // Trigger update mit neuem Objekt

            updateMonthDisplay();
            
            // Lade Daten fÃ¼r den neuen Monat
            if (appState.location) {
                document.getElementById('month-table-body').innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="loader mx-auto"></div></td></tr>';
                fetchPrayerData();
            }
        }

        function updateMonthDisplay() {
            const options = { month: 'long', year: 'numeric' };
            document.getElementById('month-display').innerText = appState.viewDate.toLocaleDateString('de-DE', options);
        }

        // --- Location Logic ---

        function saveLocation(name, lat, lng) {
            appState.location = { name, lat, lng };
            localStorage.setItem('prayerAppLocation', JSON.stringify(appState.location));
            
            document.getElementById('location-name').innerText = name;
            
            // Close settings only if opened (simple toggle logic might need care, but fine here)
            // Ideally we check if it's visible. 
            const settingsPanel = document.getElementById('settings-panel');
            if(!settingsPanel.classList.contains('hidden')) {
                settingsPanel.classList.add('hidden');
            }

            fetchPrayerData(); 
        }

        // 1. Browser Geolocation
        function detectLocation() {
            const loader = document.getElementById('location-loading');
            loader.classList.remove('hidden');
            loader.classList.add('flex');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        reverseGeocode(lat, lng);
                    },
                    (error) => {
                        console.warn("Browser geo failed", error);
                        detectLocationViaIP(); 
                    }
                );
            } else {
                detectLocationViaIP();
            }
        }

        // 2. IP Geolocation Fallback
        async function detectLocationViaIP() {
            try {
                const response = await fetch('https://ipwho.is/'); 
                const data = await response.json();
                
                if (data.success) {
                    saveLocation(data.city, data.latitude, data.longitude);
                } else {
                    throw new Error("IP Location failed");
                }
            } catch (e) {
                console.error("Standort fehlgeschlagen", e);
                if (!appState.location) {
                    saveLocation(DEFAULT_LOCATION.name, DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lng);
                    alert("Standort nicht ermittelbar. Berlin geladen.");
                }
            } finally {
                const loader = document.getElementById('location-loading');
                loader.classList.remove('flex');
                loader.classList.add('hidden');
            }
        }

        // Reverse Geocode
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                const city = data.address.city || data.address.town || data.address.village || "Mein Standort";
                saveLocation(city, lat, lng);
            } catch (e) {
                saveLocation("Mein Standort", lat, lng);
            } finally {
                const loader = document.getElementById('location-loading');
                loader.classList.remove('flex');
                loader.classList.add('hidden');
            }
        }

        // Manual Search
        async function searchCity() {
            const query = document.getElementById('city-search').value;
            if (!query) return;

            const btn = document.querySelector('#settings-panel button'); // Gets the first button in panel (search)
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>';

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data && data.length > 0) {
                    saveLocation(data[0].name, parseFloat(data[0].lat), parseFloat(data[0].lon));
                    document.getElementById('city-search').value = '';
                } else {
                    alert('Stadt nicht gefunden.');
                }
            } catch (e) {
                console.error(e);
                alert('Fehler bei der Suche.');
            } finally {
                btn.innerHTML = originalHTML;
            }
        }

        // --- Aladhan API Integration ---

        async function fetchPrayerData() {
            if (!appState.location) return;

            // Nutze appState.viewDate statt new Date() fÃ¼r die Abfrage
            const viewDate = appState.viewDate;
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth() + 1;
            
            // Use the selected method
            const method = appState.method || DEFAULT_METHOD;
            
            const url = `https://api.aladhan.com/v1/calendar/${year}/${month}?latitude=${appState.location.lat}&longitude=${appState.location.lng}&method=${method}&school=1`;

            try {
                const response = await fetch(url);
                const json = await response.json();
                
                if (json.code === 200) {
                    processAPIData(json.data);
                }
            } catch (e) {
                console.error("API Error", e);
                document.getElementById('prayer-list').innerHTML = '<div class="p-4 text-red-500 text-center">Fehler beim Laden der Daten.</div>';
            }
        }

        function processAPIData(data) {
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            // Check ob die geladenen Daten dem aktuellen realen Monat entsprechen
            // API gibt Datum im gregorian object zurÃ¼ck
            if (data.length > 0) {
                const dataMonth = parseInt(data[0].date.gregorian.month.number);
                const dataYear = parseInt(data[0].date.gregorian.year);
                
                const isCurrentMonth = (dataMonth === currentMonth && dataYear === currentYear);

                // NUR wenn wir im aktuellen Monat sind, aktualisieren wir die "Heute" Ansicht
                if (isCurrentMonth) {
                    const todayDate = now.getDate();
                    const todayData = data.find(d => parseInt(d.date.gregorian.day) === todayDate);

                    if (todayData) {
                        appState.timings = todayData.timings;
                        
                        const hijri = todayData.date.hijri;
                        document.getElementById('hijri-date').innerText = `${hijri.day} ${hijri.month.en} ${hijri.year}`;

                        updatePrayerStates(appState.timings); 
                        renderTodayList(appState.timings);
                    }
                }
            }
            
            // Die Kalendertabelle wird IMMER aktualisiert mit den geladenen Daten
            renderMonthTable(data);
        }

        function parseTime(timeStr) {
            return timeStr.split(' ')[0];
        }

        // Neue Logik fÃ¼r Status & Countdown
        function updatePrayerStates(timings) {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            // 1. NÃ¤chstes Gebet finden (fÃ¼r Countdown)
            // Wir schauen nur nach den Gebeten fÃ¼r den Countdown (TRACKED_PRAYERS)
            let foundNext = false;
            for (let prayer of TRACKED_PRAYERS) {
                const timeRaw = parseTime(timings[prayer]);
                const [h, m] = timeRaw.split(':').map(Number);
                const prayerMinutes = h * 60 + m;

                if (prayerMinutes > currentTime) {
                    appState.nextPrayer = {
                        name: prayer,
                        time: timeRaw,
                        obj: new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m)
                    };
                    foundNext = true;
                    break;
                }
            }

            if (!foundNext) {
                const fajrRaw = parseTime(timings['Fajr']);
                const [h, m] = fajrRaw.split(':').map(Number);
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(h, m, 0, 0);

                appState.nextPrayer = {
                    name: 'Fajr',
                    time: fajrRaw,
                    obj: tomorrow
                };
            }

            document.getElementById('next-prayer-name').innerText = PRAYER_NAMES[appState.nextPrayer.name];

            // 2. Aktuelles Gebet finden (fÃ¼r Hervorhebung in der Liste)
            // Hier nutzen wir alle Events inkl. Sunrise, damit die Markierung korrekt weiterspringt
            const allEvents = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            let current = null;

            for (let event of allEvents) {
                const timeRaw = parseTime(timings[event]);
                const [h, m] = timeRaw.split(':').map(Number);
                const eventMinutes = h * 60 + m;

                if (eventMinutes <= currentTime) {
                    current = event; // Merke das letzte Event, das <= jetzt ist
                }
            }

            // SONDERFALL: Nach Sonnenaufgang direkt auf Dhuhr switchen
            // Da Fajr nur bis Sonnenaufgang geht, springt das Highlight danach direkt auf das nÃ¤chste Pflichtgebet (Dhuhr)
            if (current === 'Sunrise') {
                current = 'Dhuhr';
            }

            appState.currentPrayer = current;
        }

        function updateCountdown() {
            if (!appState.nextPrayer) return;

            const now = new Date();
            const diff = appState.nextPrayer.obj - now;

            if (diff <= 0) {
                // Wenn wir den Monat gewechselt haben und der Countdown ablÃ¤uft,
                // wollen wir eigentlich die "echten" Daten neu laden.
                // Da fetchPrayerData nun viewDate nutzt, setzen wir viewDate kurz zurÃ¼ck oder laden separat.
                // Einfacher Hack: Wir setzen viewDate auf Heute zurÃ¼ck, damit der User sieht dass ein neuer Tag ist.
                // Oder wir lassen es so, dann aktualisiert sich nur der Countdown falls mÃ¶glich.
                // Beste UX: Seite neu laden oder current data neu fetchen.
                
                // Wir resetten hier viewDate auf current date um sicherzugehen dass "Heute" aktualisiert wird
                appState.viewDate = new Date();
                updateMonthDisplay();
                fetchPrayerData(); 
                return;
            }

            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('countdown').innerText = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function renderTodayList(timings) {
            const container = document.getElementById('prayer-list');
            container.innerHTML = '';

            const order = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

            order.forEach(key => {
                const time = parseTime(timings[key]);
                // Ã„NDERUNG: PrÃ¼fe auf currentPrayer statt nextPrayer
                const isActive = appState.currentPrayer === key;
                
                let icon = 'fa-clock';
                if(key === 'Fajr') icon = 'fa-cloud-sun';
                if(key === 'Sunrise') icon = 'fa-sun';
                if(key === 'Dhuhr') icon = 'fa-sun';
                if(key === 'Asr') icon = 'fa-cloud-sun';
                if(key === 'Maghrib') icon = 'fa-moon';
                if(key === 'Isha') icon = 'fa-star';

                const html = `
                    <div class="flex justify-between items-center p-4 transition-all duration-300 ${isActive ? 'prayer-active' : 'hover:bg-gray-50'}">
                        <div class="flex items-center gap-3">
                            <div class="w-8 text-center"><i class="fas ${icon} ${isActive ? 'text-white' : 'text-emerald-500'}"></i></div>
                            <span class="font-medium">${PRAYER_NAMES[key] || key}</span>
                        </div>
                        <span class="font-bold font-mono text-lg">${time}</span>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function renderMonthTable(data) {
            const tbody = document.getElementById('month-table-body');
            tbody.innerHTML = '';
            
            const now = new Date();
            const currentDay = now.getDate();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            // Datenmonat ermitteln fÃ¼r Highlighting
            const dataMonth = parseInt(data[0].date.gregorian.month.number);
            const dataYear = parseInt(data[0].date.gregorian.year);
            const isCurrentMonthView = (dataMonth === currentMonth && dataYear === currentYear);

            data.forEach(day => {
                const t = day.timings;
                const d = day.date.gregorian;
                const dayNum = parseInt(d.day);
                
                // Highlight nur wenn es wirklich heute ist (Tag + Monat + Jahr stimmen)
                const isToday = isCurrentMonthView && (dayNum === currentDay);

                // Responsive padding and hidden month name on mobile
                const row = `
                    <tr class="border-b ${isToday ? 'bg-emerald-100 font-semibold' : 'hover:bg-gray-50'}">
                        <td class="px-2 py-2 md:px-4 md:py-3 whitespace-nowrap">${d.day}. <span class="hidden sm:inline">${d.month.en.slice(0,3)}</span></td>
                        <td class="px-1 py-2 md:px-4 md:py-3 text-center">${parseTime(t.Fajr)}</td>
                        <td class="px-1 py-2 md:px-4 md:py-3 text-center">${parseTime(t.Dhuhr)}</td>
                        <td class="px-1 py-2 md:px-4 md:py-3 text-center">${parseTime(t.Asr)}</td>
                        <td class="px-1 py-2 md:px-4 md:py-3 text-center">${parseTime(t.Maghrib)}</td>
                        <td class="px-1 py-2 md:px-4 md:py-3 text-center">${parseTime(t.Isha)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- Copy Logic for Scriptable Code ---
        function copyScriptableCode() {
            // The user provided code block for Scriptable
            const code = `// gebetszeiten.live

const DEFAULT = {
Â  city: "Berlin",
Â  country: "Germany",
Â  method: 3
};

// --- FARBPALETTE ---
const COLORS = {
Â  "grÃ¼n": "#10b981",
Â  "green": "#10b981",
Â  "emerald": "#10b981",
Â  "blau": "#3b82f6",
Â  "blue": "#3b82f6",
Â  "tÃ¼rkis": "#06b6d4",
Â  "cyan": "#06b6d4",
Â  "rot": "#ef4444",
Â  "red": "#ef4444",
Â  "pink": "#ec4899",
Â  "magenta": "#d946ef",
Â  "lila": "#8b5cf6",
Â  "purple": "#8b5cf6",
Â  "orange": "#f97316",
Â  "gelb": "#eab308",
Â  "yellow": "#eab308",
Â  "grau": "#6b7280",
Â  "gray": "#6b7280"
};

// Fallback Farbe
let THEME_COLOR_HEX = "#10b981";

// --- PARAMETER LOGIC ---
// UnterstÃ¼tzte Formate: "Stadt", "Stadt, Farbe", "Stadt, Methode", "Stadt, Farbe, Methode"
// Beispiele: "Berlin", "Berlin, Pink", "Berlin, 5", "Berlin, Pink, 5"

let cityParam = DEFAULT.city;

if (args.widgetParameter) {
Â  const params = args.widgetParameter.split(",");
Â Â 
Â  // 1. Stadt (immer an erster Stelle)
Â  if (params[0] && params[0].trim() !== "") {
Â  Â  cityParam = params[0].trim();
Â  }
Â Â 
Â  // Weitere Parameter flexibel parsen (Farbe oder Methode)
Â  for (let i = 1; i < params.length; i++) {
Â  Â  let p = params[i].trim();
Â  Â  if (p === "") continue;
Â  Â Â 
Â  Â  // Check: Ist es eine Zahl? -> Methode ID
Â  Â  if (!isNaN(p)) {
Â  Â  Â  DEFAULT.method = parseInt(p);
Â  Â  Â  continue;
Â  Â  }
Â  Â Â 
Â  Â  // Check: Ist es eine Farbe?
Â  Â  let lowerC = p.toLowerCase();
Â  Â  if (COLORS[lowerC]) {
Â  Â  Â  THEME_COLOR_HEX = COLORS[lowerC];
Â  Â  } else if (lowerC.startsWith("#")) {
Â  Â  Â  THEME_COLOR_HEX = lowerC;
Â  Â  }
Â  }
}

// Colors
const THEME_COLOR = new Color(THEME_COLOR_HEX);
// SAFE Darkening Logic using Hex String Reconstruction
// Avoids "expected string but got number" error in some versions
const BG_TOP = getDarkVariant(THEME_COLOR_HEX, 0.2);Â 
const BG_BOT = getDarkVariant(THEME_COLOR_HEX, 0.1);Â 

// Init Widget
const widget = new ListWidget();
const gradient = new LinearGradient();
gradient.colors = [BG_TOP, BG_BOT];
gradient.locations = [0, 1];
widget.backgroundGradient = gradient;

try {
Â  let now = new Date();
Â  let data = await fetchPrayerData(now, cityParam);
Â  let timings = data.timings;
Â Â 
Â  const ishaStr = timings['Isha'].split(' ')[0];
Â  const [h, m] = ishaStr.split(':').map(Number);
Â  const ishaDate = new Date(now);
Â  ishaDate.setHours(h, m, 0, 0);
Â Â 
Â  let isNextDay = false;
Â  if (now > ishaDate) {
Â  Â  Â const tomorrow = new Date(now);
Â  Â  Â tomorrow.setDate(tomorrow.getDate() + 1);
Â  Â  Â data = await fetchPrayerData(tomorrow, cityParam);
Â  Â  Â timings = data.timings;
Â  Â  Â isNextDay = true;
Â  }
Â Â 
Â  const hijri = data.date.hijri;
Â  let next;
Â  if (isNextDay) {
Â  Â  Â next = { name: 'Fajr', time: timings['Fajr'].split(' ')[0] };
Â  } else {
Â  Â  Â next = getNextPrayerToday(timings);
Â  }
Â Â 
Â  // --- RESPONSIVE UI ---
Â  const family = config.widgetFamily || "medium";
Â Â 
Â  if (family === 'small') {
Â  Â  Â  renderSmall(widget, next, timings);
Â  } else {
Â  Â  Â  renderMedium(widget, next, timings, hijri, cityParam);
Â  }
Â Â 
Â  widget.refreshAfterDate = new Date(Date.now() + 60 * 60 * 1000);

} catch (e) {
Â  widget.addText("Err: " + e.message).textColor = Color.red();
}

Script.setWidget(widget);
Script.complete();

if (config.runsInApp) {
Â  Â  if ("medium" === "small") {
Â  Â  Â  Â  widget.presentSmall();
Â  Â  } else {
Â  Â  Â  Â  widget.presentMedium();
Â  Â  }
}

// --- RENDER FUNCTIONS ---

function renderSmall(w, next, timings) {
Â  Â  w.setPadding(12, 12, 12, 12);
Â  Â Â 
Â  Â  const topStack = w.addStack();
Â  Â  topStack.layoutVertically();
Â  Â  topStack.centerAlignContent();Â 
Â  Â Â 
Â  Â  const nextLabel = topStack.addText("NÃ„CHSTES GEBET: " + mapName(next.name).toUpperCase());
Â  Â  nextLabel.font = Font.boldSystemFont(9);
Â  Â  nextLabel.textColor = THEME_COLOR;
Â  Â  nextLabel.centerAlignText();
Â  Â Â 
Â  Â  const nextTime = topStack.addText(next.time);
Â  Â  nextTime.font = Font.boldSystemFont(32);Â 
Â  Â  nextTime.textColor = Color.white();
Â  Â  nextTime.centerAlignText();
Â  Â Â 
Â  Â  w.addSpacer(8);
Â  Â Â 
Â  Â  const listStack = w.addStack();
Â  Â  listStack.layoutVertically();
Â  Â Â 
Â  Â  const prayers = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
Â  Â Â 
Â  Â  for (let pName of prayers) {
Â  Â  Â  Â  const pTime = timings[pName].split(' ')[0];
Â  Â  Â  Â  const isActive = (pName === next.name);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const row = listStack.addStack();
Â  Â  Â  Â  row.layoutHorizontally();
Â  Â  Â  Â Â 
Â  Â  Â  Â  const nameT = row.addText(mapName(pName));
Â  Â  Â  Â  nameT.font = isActive ? Font.boldSystemFont(9) : Font.systemFont(9);
Â  Â  Â  Â  nameT.textColor = isActive ? THEME_COLOR : new Color("#888888");
Â  Â  Â  Â Â 
Â  Â  Â  Â  row.addSpacer();
Â  Â  Â  Â Â 
Â  Â  Â  Â  const timeT = row.addText(pTime);
Â  Â  Â  Â  timeT.font = isActive ? Font.boldSystemFont(9) : Font.systemFont(9);
Â  Â  Â  Â  timeT.textColor = isActive ? Color.white() : new Color("#cccccc");
Â  Â  Â  Â Â 
Â  Â  Â  Â  listStack.addSpacer(2);
Â  Â  }
}

function renderMedium(w, next, timings, hijri, cityName) {
Â  const headerStack = w.addStack();
Â  headerStack.layoutHorizontally();
Â  headerStack.topAlignContent();Â 
Â Â 
Â  const infoStack = headerStack.addStack();
Â  infoStack.layoutVertically();
Â Â 
Â  const cityText = infoStack.addText(String(cityName));
Â  cityText.font = Font.boldSystemFont(14);
Â  cityText.textColor = Color.white();
Â Â 
Â  const hijriText = infoStack.addText(\`\${hijri.day} \${hijri.month.en}\`);
Â  hijriText.font = Font.systemFont(10);
Â  hijriText.textColor = THEME_COLOR;
Â Â 
Â  headerStack.addSpacer();
Â Â 
Â  const nextStack = headerStack.addStack();
Â  nextStack.layoutVertically();
Â  nextStack.bottomAlignContent();Â 
Â Â 
Â  const nextLabel = nextStack.addText("NÃ„CHSTES GEBET: " + mapName(next.name).toUpperCase());
Â  nextLabel.font = Font.boldSystemFont(10);
Â  nextLabel.textColor = THEME_COLOR;
Â  nextLabel.rightAlignText();
Â Â 
Â  const nextTime = nextStack.addText(next.time);
Â  nextTime.font = Font.boldSystemFont(46);
Â  nextTime.textColor = Color.white();
Â  nextTime.rightAlignText();
Â Â 
Â  w.addSpacer();
Â Â 
Â  const listStack = w.addStack();
Â  listStack.layoutHorizontally();
Â  listStack.centerAlignContent();
Â Â 
Â  const prayers = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
Â Â 
Â  for (let i = 0; i < prayers.length; i++) {
Â  Â  const pName = prayers[i];
Â  Â  const pTime = timings[pName].split(' ')[0];
Â  Â  const isActive = (pName === next.name);
Â  Â  addPrayerItem(listStack, pName, pTime, isActive);
Â  Â  if (i < prayers.length - 1) listStack.addSpacer();
Â  }
}

// --- HELPERS ---

async function fetchPrayerData(dateObj, city) {
Â  const dateStr = \`\${dateObj.getDate()}-\${dateObj.getMonth()+1}-\${dateObj.getFullYear()}\`;
Â Â 
Â  let c = encodeURI(String(city));
Â  let co = encodeURI(String(DEFAULT.country));
Â  let m = String(DEFAULT.method);
Â Â 
Â  const url = \`https://api.aladhan.com/v1/timingsByCity/\${dateStr}?city=\${c}&country=\${co}&method=\${m}&school=1\`;
Â  const req = new Request(url);
Â  return (await req.loadJSON()).data;
}

function getNextPrayerToday(timings) {
Â  const now = new Date();
Â  const currentMins = now.getHours() * 60 + now.getMinutes();
Â  const order = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
Â  for (let name of order) {
Â  Â  const timeStr = timings[name].split(' ')[0];
Â  Â  const [h, m] = timeStr.split(':').map(Number);
Â  Â  const mins = h * 60 + m;
Â  Â  if (mins > currentMins) return { name: name, time: timeStr };
Â  }
Â  return { name: 'Fajr', time: timings['Fajr'].split(' ')[0] };
}

function addPrayerItem(stack, name, time, isActive) {
Â  const itemStack = stack.addStack();
Â  itemStack.layoutVertically();
Â  itemStack.centerAlignContent();
Â Â 
Â  const nameTxt = itemStack.addText(mapName(name));
Â  nameTxt.font = isActive ? Font.boldSystemFont(9) : Font.systemFont(9);
Â  nameTxt.textColor = isActive ? THEME_COLOR : new Color("#888888");
Â  nameTxt.centerAlignText();
Â  itemStack.addSpacer(2);
Â  const timeStack = itemStack.addStack();
Â  if (isActive) {
Â  Â  timeStack.backgroundColor = new Color("#ffffff", 0.15);Â 
Â  Â  timeStack.cornerRadius = 4;
Â  Â  timeStack.setPadding(2, 4, 2, 4);
Â  }
Â  const timeTxt = timeStack.addText(time);
Â  timeTxt.font = isActive ? Font.boldSystemFont(11) : Font.mediumSystemFont(11);
Â  timeTxt.textColor = isActive ? Color.white() : new Color("#cccccc");
}

function mapName(key) {
Â  const map = { "Fajr": "Fajr", "Sunrise": "Shuruk", "Dhuhr": "Dhuhr", "Asr": "Asr", "Maghrib": "Maghrib", "Isha": "Isha" };
Â  return map[key] || key;
}

function getDarkVariant(hex, factor) {
Â  Â let c = new Color(hex);
Â  Â let r = Math.floor(c.red * factor * 255);
Â  Â let g = Math.floor(c.green * factor * 255);
Â  Â let b = Math.floor(c.blue * factor * 255);
Â  Â let toHex = (n) => ("0" + n.toString(16)).slice(-2);
Â  Â return new Color("#" + toHex(r) + toHex(g) + toHex(b));
}`;

            // Create hidden textarea to copy content (works better in iframes/webviews than navigator.clipboard)
            const el = document.createElement('textarea');
            el.value = code;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            // Visual feedback
            const btnText = document.getElementById('copy-btn-text');
            const originalText = btnText.innerText;
            const btn = document.getElementById('copy-widget-btn');
            
            btnText.innerText = "Code kopiert!";
            btn.classList.add('bg-emerald-100', 'text-emerald-700', 'border-emerald-200');
            btn.classList.remove('bg-slate-100', 'text-slate-700', 'border-slate-200');

            // Revert after 2 seconds
            setTimeout(() => {
                btnText.innerText = originalText;
                btn.classList.remove('bg-emerald-100', 'text-emerald-700', 'border-emerald-200');
                btn.classList.add('bg-slate-100', 'text-slate-700', 'border-slate-200');
            }, 2000);
        }
    </script>
</body>
</html>
